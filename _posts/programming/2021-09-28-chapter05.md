---
layout: post
title: (Python) 파이썬과 Opencv를 이용한 컴퓨터 비전 학습 Chapter05
description: |
  Opencv3 computer vision with python cookbook
hide_image: true
tags:
  - programming
published: true
---

Chapter05.딥러닝

# 5.1. 이미지를 텐서/블롭(blobs)으로 표현
* * *
딥러닝은 한번에 많은 이미지를 처리하는데, 이런 여러 이미지의 묶음을 **배치**, 배치를 한번에 처리하는 것을 **일괄처리**라 한다.
opencv의 딥러닝 기능은 (배치에 포함된 이미지의 수N, 채널의 수C, 이미지의 높이H, 이미지의 너비W)로 구성된 4차원 텐서로 동작하므로 
배열 형태의 이미지 input을 tensor자료형으로 변환해주어야 한다. 변환 과정은 다음과 같다.   
   
* 이미지를 [부동 소수점](https://codetorial.net/articles/floating_point.html) 으로 변환한다.
* 필요한 경우 채널의 순서를 BGR에서 RGB로 변환한다.
* HWC이미지를 CHW텐서로 변환한다.
* CHW텐서에 차원을 추가해 **NCHW**로 만든다.
[배열 전환 참고](https://pybasall.tistory.com/124)

```py
 #필요한 모듈을 불러온다
import cv2   
import numpy as np

#BGR채널의 이미지를 컬러로 불러온다.
image_bgr = cv2.imread('../data/Lena.png', cv2.IMREAD_COLOR)
print(image_bgr.shape)

#이미지를 4차원 부동소수점 텐서로 변경
image_bgr_float = image_bgr.astype(np.float32)  #위에서 불러온 이미지의 데이터 형태를 float32형태로 변환
                                                #float32는 32bits의 실수
image_rgb = image_bgr_float[..., ::-1]  #BGR을 RGB로 변경
tensor_chw = np.transpose(image_rgb, (2, 0, 1)) #image_rgb(512높이,512너비,3채널) --> tensor_chw(3채널,512높이,512너비)
tensor_nchw = tensor_chw[np.newaxis, ...]    #(3,512,512)에 새로운 축 하나를 추가 --> (1N,3C,512H,512W)

print(tensor_nchw.shape)
```
```
>>> (1,3,512,512)
```

# 5.2. Caffe,Torch,텐서플로 형식의 딥러닝 모델 불러오기
* * *
opencv에서 dnn모듈을 사용하면 Caffe,Torch,TensorFlow 세가지 프레임워크로 사전 훈련된 네트워크를 불러올 수 있다. 

```py
import cv2
import numpy as np

#Caffe 모델
net_caffe = cv2.dnn.readNetFromCaffe('../data/bvlc_googlenet.prototxt', 
                                     '../data/bvlc_googlenet.caffemodel')
#Torch 모델
net_torch = cv2.dnn.readNetFromTorch('../data/torch_enet_model.net')

#tensorflow모델
net_tensorflow = cv2.dnn.readNetFromTensorflow('../data/tensorflow_inception_graph.pb')
```

# 5.3. 모든 레이어에 대한 입/출력 텐서 형태 가져오기
* * *
DNN에서 Forward pass를 수행하는 동안 데이터 형태에 대한 정보가 필요한 경우가 있다. 다음의 함수로 추론(훈련된 신경망으로 구체적인 작업을 수행하는 것)없이 모든 텐서의 형태를 얻을 수 있다.



```py
import cv2
import numpy as np

net = cv2.dnn.readNetFromCaffe('../data/bvlc_googlenet.prototxt', 
                               '../data/bvlc_googlenet.caffemodel')ㅣ
if not net.empty(): #네트워크에 어떠한 layer도 포함되지 않으면 empty함수는 True를 반환한다.즉, layer가 비어있지 않다면 
    print('Net loaded successfully\n')  #'Net loaded successfully'출력
    
print('Net contains:') 
for t in net.getLayerTypes(): #네트워크에 포함된 레이어들의 유형에 대한 정보 출력
    print('\t%d layers of type %s' % (net.getLayersCount(t), t)) #get.LayerCount : 레이어 유형을 입력받아 해당 유형의 레이어 수 반환

layers_ids, in_shapes, out_shapes = net.getLayersShapes([1, 3, 224, 224]) #예제수, 채넔, 너비, 높이 4개의 정수를 받아 모든 텐서의 형태를 계산하는 함수
                                                                          #layers_ids : 레이어 식별자 목록
                                                                          #in_shapes : 각 레이어에 대한 입력 텐서 형태 목록
                                                                          #out_shapes: 각 레이어에 대한 출력 텐서 형태 목록
                                                                          

layers_names = net.getLayerNames()  #layer 이름 목록 반환

print('Net layers shapes:')
for l in range(len(layers_names)):
    in_num, out_num = len(in_shapes[l]), len(out_shapes[l])
    print('Layer "%s" has %d input(s) and %d output(s)' % (layers_names[l], in_num, out_num)) #layer이름, input수, output수 
    for i in range(in_num):
        print('\tinput #%d has shape' % i, in_shapes[l][i].flatten())
    for i in range(out_num):
        print('\toutput #%d has shape' % i, out_shapes[l][i].flatten())
```

# 5.4. 이미지 사전 처리와 convolution network 추론
* * *
인공신경망 훈련을 위해 다음의 조건이 필요하다
* 네트워크에서 처리할 수 있는 형식과 범위의 입력 데이터가 있어야 함
* 데이터를 네트워크에 적절히 전달해야 함

```py
import cv2
import numpy as np

#이미지를 열고 
image = cv2.imread('../data/Lena.png', cv2.IMREAD_COLOR)
#전처리를 통해 tensor로 전환
tensor = cv2.dnn.blobFromImage(image, 1.0, (224, 224),
                               (104, 117, 123), False, False);

#두 장의 이미지를 tensor로 전환
tensor = cv2.dnn.blobFromImages([image, image], 1.0, (224, 224),
                                (104, 117, 123), False, True);                               

#훈련된 신경망 모델 불러오기
net = cv2.dnn.readNetFromCaffe('../data/bvlc_googlenet.prototxt', 
                               '../data/bvlc_googlenet.caffemodel')                                     
#불러온 모델로 추론 수행
net.setInput(tensor);
prob = net.forward();

#입력 설정 반복을 통해 지정된 레이어명으로 추론 수행
net.setInput(tensor, 'data');
prob = net.forward('prob');
```
